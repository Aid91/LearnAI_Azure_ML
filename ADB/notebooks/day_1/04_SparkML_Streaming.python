{"version":"NotebookV1","origId":2681151230257552,"name":"04 SparkML Streaming","language":"python","commands":[{"version":"CommandV1","origId":2681151230257553,"guid":"f55c632e-96cb-405a-83b7-a230ad639a39","subtype":"command","commandType":"auto","position":1.0,"command":"%md-sandbox\n<div style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://databricks.com/wp-content/uploads/2018/03/db-academy-rgb-1200px.png\" alt=\"Databricks Learning\" style=\"width: 600px; height: 163px\">\n</div>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"56b1f299-8ab1-4a59-a563-e459e2190c17"},{"version":"CommandV1","origId":2681151230257554,"guid":"e7ce8d62-77c5-46ea-958f-6b2582ba9db4","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n## SparkML on Streaming Data","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e35acd3f-e012-4064-9a20-99347d7d46e8"},{"version":"CommandV1","origId":2681151230257555,"guid":"c80855ca-f474-4c8a-98da-8ca76262830d","subtype":"command","commandType":"auto","position":3.0,"command":"%md\nLet's take in the model we saved earlier, and apply it to some streaming data!","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5d43c43c-2067-4f62-aacc-d1369c9f22dd"},{"version":"CommandV1","origId":2681151230257556,"guid":"543233fa-be42-4c5f-921a-fc1cbb8ff4bf","subtype":"command","commandType":"auto","position":4.0,"command":"%run \"../Includes/Classroom Setup\"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0ae1c84b-c33b-4c0c-93f8-9b8484ec1252"},{"version":"CommandV1","origId":2681151230257557,"guid":"9b85ae7a-4fb5-48e3-a64e-62ad8df51a60","subtype":"command","commandType":"auto","position":5.0,"command":"from pyspark.ml.pipeline import PipelineModel\n\nfileName = userhome + \"/tmp/DT_Pipeline\"\npipelineModel = PipelineModel.load(fileName)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5e560e8a-917e-433f-91c2-d509434e076f"},{"version":"CommandV1","origId":2681151230257558,"guid":"04da19a6-bccc-4a14-bbc0-2fe12c0fddb0","subtype":"command","commandType":"auto","position":6.0,"command":"%md\nWe can simulate streaming data.\n\nNOTE: You must specify a schema when creating a streaming source DataFrame.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2a07f334-a506-44bc-8359-47359c2667d2"},{"version":"CommandV1","origId":2681151230257559,"guid":"e91d8012-d4ab-458d-9c7d-bde8b2853263","subtype":"command","commandType":"auto","position":7.0,"command":"from pyspark.sql.types import *\n\nschema = StructType([\n  StructField(\"rating\",DoubleType()), \n  StructField(\"review\",StringType())])\n\nstreamingData = (spark\n                 .readStream\n                 .schema(schema)\n                 .option(\"maxFilesPerTrigger\", 1)\n                 .parquet(\"/mnt/training/movie-reviews/imdb/imdb_ratings_50k.parquet\"))","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b309ba6f-2ab9-470a-bac3-0070526178ff"},{"version":"CommandV1","origId":2681151230257560,"guid":"ba99aaf3-a36d-467a-84a2-b00f3086d133","subtype":"command","commandType":"auto","position":8.0,"command":"%md\nWhy is this stream taking so long? What configuration should we set?","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5d6bf358-9264-4736-bcd8-35aa907518bb"},{"version":"CommandV1","origId":2681151230257561,"guid":"6226fd91-e425-4b6d-9ae3-ba1d5c2cc32b","subtype":"command","commandType":"auto","position":9.0,"command":"stream = (pipelineModel\n          .transform(streamingData)\n          .groupBy(\"label\", \"prediction\")\n          .count()\n          .sort(\"label\", \"prediction\"))\n\ndisplay(stream)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3102c608-d0d1-4025-94b2-ec67371b6e16"},{"version":"CommandV1","origId":2681151230257562,"guid":"1bb61ba6-b6eb-4024-b2cd-d8ce83fd382e","subtype":"command","commandType":"auto","position":10.0,"command":"spark.conf.get(\"spark.sql.shuffle.partitions\")","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6e42d690-370b-4924-b4de-44030252d637"},{"version":"CommandV1","origId":2681151230257563,"guid":"f8da6972-73f0-4aeb-a3da-0f1edb12ca4f","subtype":"command","commandType":"auto","position":11.0,"command":"spark.conf.set(\"spark.sql.shuffle.partitions\", \"8\")","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3a8e18de-ad04-404d-a78a-6fa838916714"},{"version":"CommandV1","origId":2681151230257564,"guid":"cbbda690-6ae5-4fc6-a69f-a8aefcd0d976","subtype":"command","commandType":"auto","position":12.0,"command":"%md\nLet's try this again","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4cad6230-2f10-423a-addd-936653bd7ecd"},{"version":"CommandV1","origId":2681151230257565,"guid":"7e104ce5-2f87-4af9-947e-622fcf0f2ef5","subtype":"command","commandType":"auto","position":13.0,"command":"stream = (pipelineModel\n          .transform(streamingData)\n          .groupBy(\"label\", \"prediction\")\n          .count()\n          .sort(\"label\", \"prediction\"))\n\ndisplay(stream)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d7f19370-c2a5-4ab9-90b5-c13aa41cd64a"},{"version":"CommandV1","origId":2681151230257566,"guid":"146734da-7b19-4320-9c3b-32c58b2f9fd0","subtype":"command","commandType":"auto","position":14.0,"command":"%md\nLet's save our results to a file.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"64849b73-8a72-4071-a411-a0c31449661c"},{"version":"CommandV1","origId":2681151230257567,"guid":"fb1678fd-5ef3-485d-8266-cc74d7b43b74","subtype":"command","commandType":"auto","position":15.0,"command":"import re\n\nstreamingView = re.sub('\\W', '', username)\ncheckpointFile = userhome + \"/tmp/checkPoint\"\ndbutils.fs.rm(checkpointFile, True) # Clear out the checkpointing directory\n\n(stream\n .writeStream\n .format(\"memory\")\n .option(\"checkpointLocation\", checkpointFile)\n .outputMode(\"complete\")\n .queryName(streamingView)\n .start())","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8b1ae5fe-5c16-4277-87cd-58908a996232"},{"version":"CommandV1","origId":2681151230257568,"guid":"dd02dd33-bcca-4901-a158-dd30dc0ef40e","subtype":"command","commandType":"auto","position":16.0,"command":"display(sql(\"select * from \" + streamingView))","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"85881be4-78d6-469f-a0b6-35664e2ea191"},{"version":"CommandV1","origId":2681151230257569,"guid":"a6a74533-b41a-4ba0-ab07-6b138159caca","subtype":"command","commandType":"auto","position":17.0,"command":"%md-sandbox\n&copy; 2018 Databricks, Inc. All rights reserved.<br/>\nApache, Apache Spark, Spark and the Spark logo are trademarks of the <a href=\"http://www.apache.org/\">Apache Software Foundation</a>.<br/>\n<br/>\n<a href=\"https://databricks.com/privacy-policy\">Privacy Policy</a> | <a href=\"https://databricks.com/terms-of-use\">Terms of Use</a> | <a href=\"http://help.databricks.com/\">Support</a>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6607b537-b08d-4b12-ab92-0da1a6b1d6b0"}],"dashboards":[],"guid":"a73a0416-3f4b-458b-aa72-437a0cb5b9a4","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}
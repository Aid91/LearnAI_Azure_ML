{"version":"NotebookV1","origId":4190353649973308,"name":"04 SparkML Streaming","language":"python","commands":[{"version":"CommandV1","origId":4190353649973309,"guid":"9653c5dd-f804-464f-9895-ebdbbc9f3d03","subtype":"command","commandType":"auto","position":1.0,"command":"%md-sandbox\n<div style=\"text-align: center; line-height: 0; padding-top: 9px;\">\n  <img src=\"https://databricks.com/wp-content/uploads/2018/03/db-academy-rgb-1200px.png\" alt=\"Databricks Learning\" style=\"width: 600px; height: 163px\">\n</div>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"56b1f299-8ab1-4a59-a563-e459e2190c17"},{"version":"CommandV1","origId":4190353649973310,"guid":"2229c9db-ff37-43ea-b55f-bb47d8efb5b1","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n## SparkML on Streaming Data","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e35acd3f-e012-4064-9a20-99347d7d46e8"},{"version":"CommandV1","origId":4190353649973311,"guid":"02652c24-012b-4cad-a4b8-79d3ee98b3da","subtype":"command","commandType":"auto","position":3.0,"command":"%md\nLet's take in the model we saved earlier, and apply it to some streaming data!","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5d43c43c-2067-4f62-aacc-d1369c9f22dd"},{"version":"CommandV1","origId":4190353649973312,"guid":"ed56b6a5-9c0d-4547-b734-fb1e0efa897d","subtype":"command","commandType":"auto","position":4.0,"command":"%run \"../Includes/Classroom Setup\"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0ae1c84b-c33b-4c0c-93f8-9b8484ec1252"},{"version":"CommandV1","origId":4190353649973313,"guid":"64fc3cef-fdea-4cae-9ee6-99912135e719","subtype":"command","commandType":"auto","position":5.0,"command":"from pyspark.ml.pipeline import PipelineModel\n\nfileName = userhome + \"/tmp/DT_Pipeline\"\npipelineModel = PipelineModel.load(fileName)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5e560e8a-917e-433f-91c2-d509434e076f"},{"version":"CommandV1","origId":4190353649973314,"guid":"8027b332-87dd-4bf0-90c9-d1830f1262cd","subtype":"command","commandType":"auto","position":6.0,"command":"%md\nWe can simulate streaming data.\n\nNOTE: You must specify a schema when creating a streaming source DataFrame.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2a07f334-a506-44bc-8359-47359c2667d2"},{"version":"CommandV1","origId":4190353649973315,"guid":"1f7f449a-ea28-44a0-b3c1-c37d006850ea","subtype":"command","commandType":"auto","position":7.0,"command":"from pyspark.sql.types import *\n\nschema = StructType([\n  StructField(\"rating\",DoubleType()), \n  StructField(\"review\",StringType())])\n\nstreamingData = (spark\n                 .readStream\n                 .schema(schema)\n                 .option(\"maxFilesPerTrigger\", 1)\n                 .parquet(\"/mnt/training/movie-reviews/imdb/imdb_ratings_50k.parquet\"))","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b309ba6f-2ab9-470a-bac3-0070526178ff"},{"version":"CommandV1","origId":4190353649973316,"guid":"09dc608e-46a0-4a4b-ab38-54b7922a247a","subtype":"command","commandType":"auto","position":8.0,"command":"%md\nWhy is this stream taking so long? What configuration should we set?","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5d6bf358-9264-4736-bcd8-35aa907518bb"},{"version":"CommandV1","origId":4190353649973317,"guid":"5e8c726a-cde0-4800-9e52-e96184c5333c","subtype":"command","commandType":"auto","position":9.0,"command":"stream = (pipelineModel\n          .transform(streamingData)\n          .groupBy(\"label\", \"prediction\")\n          .count()\n          .sort(\"label\", \"prediction\"))\n\ndisplay(stream)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3102c608-d0d1-4025-94b2-ec67371b6e16"},{"version":"CommandV1","origId":4190353649973318,"guid":"647dedab-00a0-402e-9122-0dc4699bcb25","subtype":"command","commandType":"auto","position":10.0,"command":"spark.conf.get(\"spark.sql.shuffle.partitions\")","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6e42d690-370b-4924-b4de-44030252d637"},{"version":"CommandV1","origId":4190353649973319,"guid":"474efa87-62cf-47a7-bcc2-1e66e4b900bf","subtype":"command","commandType":"auto","position":11.0,"command":"spark.conf.set(\"spark.sql.shuffle.partitions\", \"8\")","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3a8e18de-ad04-404d-a78a-6fa838916714"},{"version":"CommandV1","origId":4190353649973320,"guid":"b59065a6-0fc7-40aa-abaf-24acedf9a3d2","subtype":"command","commandType":"auto","position":12.0,"command":"%md\nLet's try this again","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4cad6230-2f10-423a-addd-936653bd7ecd"},{"version":"CommandV1","origId":4190353649973321,"guid":"faa1e56e-3c6a-49f2-b650-59ae1c1f292e","subtype":"command","commandType":"auto","position":13.0,"command":"stream = (pipelineModel\n          .transform(streamingData)\n          .groupBy(\"label\", \"prediction\")\n          .count()\n          .sort(\"label\", \"prediction\"))\n\ndisplay(stream)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d7f19370-c2a5-4ab9-90b5-c13aa41cd64a"},{"version":"CommandV1","origId":4190353649973322,"guid":"e2396dc4-f747-44c5-ada4-c687dcb0fd88","subtype":"command","commandType":"auto","position":14.0,"command":"%md\nLet's save our results to a file.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"64849b73-8a72-4071-a411-a0c31449661c"},{"version":"CommandV1","origId":4190353649973323,"guid":"1a43e947-1e35-4128-99ec-56eba42f6f02","subtype":"command","commandType":"auto","position":15.0,"command":"import re\n\nstreamingView = re.sub('\\W', '', username)\ncheckpointFile = userhome + \"/tmp/checkPoint\"\ndbutils.fs.rm(checkpointFile, True) # Clear out the checkpointing directory\n\n(stream\n .writeStream\n .format(\"memory\")\n .option(\"checkpointLocation\", checkpointFile)\n .outputMode(\"complete\")\n .queryName(streamingView)\n .start())","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8b1ae5fe-5c16-4277-87cd-58908a996232"},{"version":"CommandV1","origId":4190353649973324,"guid":"6bfea389-4da6-4049-9ad5-53e5c6b1bd7a","subtype":"command","commandType":"auto","position":16.0,"command":"display(sql(\"select * from \" + streamingView))","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"85881be4-78d6-469f-a0b6-35664e2ea191"},{"version":"CommandV1","origId":4190353649973325,"guid":"d153c5d3-f5fe-457c-9e94-020bfc5c65e6","subtype":"command","commandType":"auto","position":17.0,"command":"%md-sandbox\n&copy; 2018 Databricks, Inc. All rights reserved.<br/>\nApache, Apache Spark, Spark and the Spark logo are trademarks of the <a href=\"http://www.apache.org/\">Apache Software Foundation</a>.<br/>\n<br/>\n<a href=\"https://databricks.com/privacy-policy\">Privacy Policy</a> | <a href=\"https://databricks.com/terms-of-use\">Terms of Use</a> | <a href=\"http://help.databricks.com/\">Support</a>","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"5858075836730959","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6607b537-b08d-4b12-ab92-0da1a6b1d6b0"}],"dashboards":[],"guid":"4481fa05-9acc-4350-ab47-736fb0651c2c","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}